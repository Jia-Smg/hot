import mph
import sys

def set_param_and_geometry(model, model_path):
    model = model.java

    # set paramter
    # every cross_shape paramater
    # line 1 (0-4)
    c = [[0.4192323186083772, 0.15182330052643628, 0.42894438086518655, 0.033789425497825584, 0.8161986724650949, 0.15001190203707943, 0.48299061570153357, 0.08418310826276032, 0.4328262760357061, 0.24443717097734036, 0.6552904554818036, 0.10027237354085602]]
    c.append([0.4192323186083772, 0.15182330052643628, 0.42894438086518655, 0.033789425497825584, 0.8161986724650949, 0.15001190203707943, 0.48299061570153357, 0.08418310826276032, 0.4328262760357061, 0.24443717097734036, 0.6552904554818036, 0.10027237354085602])
    c.append([0.4735861753261616, 0.07128496223392072, 0.4551288624399176, 0.16833005264362555, 0.7642471961547265, 0.06742275120164798, 0.4478045319295033, 0.17346669718471047, 0.3787287708857862, 0.07839459830624856, 0.8223657587548637, 0.09923964293888761])
    c.append([0.3840975051499199, 0.4537907988097963, 0.1621116960402838, 0.03563515678644999, 0.8224097047379263, 0.14195513847562372, 0.47512428473334856, 0.08438086518654159, 0.44049485008010986, 0.1313861295490959, 0.7447498283360037, 0.12386404211490042])
    c.append([0.4245571068894484, 0.11386861982146934, 0.4615742732890822, 0.1070766765850309, 0.8007956054016938, 0.09212771801327534, 0.2818498512245365, 0.3823273060196842, 0.3358228427557794, 0.16096910048065918, 0.7558974593728542, 0.0831334401464866])
    # line 2 (5-8)
    c.append([0.3547196154726482, 0.25119249256122683, 0.394087891966125, 0.018386358434424356, 0.7630826276035706, 0.21853101396200506, 0.48138658731975276, 0.040368963149462256, 0.47824444953078504, 0.12203295948729685, 0.8067136644541085, 0.07125337605859464])
    c.append([0.3021748683909361, 0.27835111009384306, 0.41947402151522084, 0.01, 0.7604678416113527, 0.2295321583886473, 0.49, 0.020000000000000018, 0.49, 0.04013962005035477, 0.9498530556191348, 0.010007324330510414])
    c.append([0.29957473105973903, 0.28084870679789437, 0.41957656214236666, 0.01, 0.7604458686198214, 0.22955413138017852, 0.49, 0.020000000000000018, 0.49, 0.03797161821927215, 0.9520283817807278, 0.01])
    c.append([0.2928290226596475, 0.28472327763790345, 0.42244769970244905, 0.010007324330510414, 0.7565786221103227, 0.23341405355916686, 0.49, 0.020000000000000018, 0.49, 0.023872281986724652, 0.9661277180132753, 0.01])
    # line 3 (9-12)
    c.append([0.48999267566948956, 0.020007324330510445, 0.49, 0.01, 0.9312346074616618, 0.05876539253833829, 0.49, 0.020000000000000018, 0.49, 0.22290363927672235, 0.7670963607232777, 0.01])
    c.append([0.3175632867933166, 0.26967177843900203, 0.4127649347676814, 0.01, 0.7767425040054933, 0.21325749599450675, 0.49, 0.020000000000000018, 0.49, 0.08279652094300755, 0.9072034790569925, 0.01])
    c.append([0.49, 0.020007324330510445, 0.48999267566948956, 0.01, 0.9333220416571297, 0.056677958342870226, 0.49, 0.020000000000000018, 0.49, 0.20164110780498973, 0.7883588921950102, 0.01])
    c.append([0.49, 0.020007324330510445, 0.48999267566948956, 0.01, 0.9333220416571297, 0.056677958342870226, 0.49, 0.020000000000000018, 0.49, 0.20164110780498973, 0.7883588921950102, 0.01])

    # line 4 (13-16)
    c.append([0.3191160448615244, 0.26888075074387724, 0.4120032043945983, 0.01, 0.7776726939803158, 0.21232730601968414, 0.49, 0.020000000000000018, 0.49, 0.08516227969787135, 0.9048377203021286, 0.01])
    c.append([0.3415651178759441, 0.2516758983749142, 0.40675898374914166, 0.01, 0.8099876401922637, 0.18001235980773633, 0.49, 0.020000000000000018, 0.49, 0.13833691920347907, 0.8516557564660104, 0.010007324330510414])
    c.append([0.3415651178759441, 0.2516758983749142, 0.40675898374914166, 0.01, 0.8099876401922637, 0.18001235980773633, 0.49, 0.020000000000000018, 0.49, 0.13833691920347907, 0.8516557564660104, 0.010007324330510414])
    c.append([0.3415651178759441, 0.2516758983749142, 0.40675898374914166, 0.01, 0.8099876401922637, 0.18001235980773633, 0.49, 0.020000000000000018, 0.49, 0.13833691920347907, 0.8516557564660104, 0.010007324330510414])

    # line 5 (same with line 4) (17-20)
    c.append([0.3191160448615244, 0.26888075074387724, 0.4120032043945983, 0.01, 0.7776726939803158, 0.21232730601968414, 0.49, 0.020000000000000018, 0.49, 0.08516227969787135, 0.9048377203021286, 0.01])
    c.append([0.3415651178759441, 0.2516758983749142, 0.40675898374914166, 0.01, 0.8099876401922637, 0.18001235980773633, 0.49, 0.020000000000000018, 0.49, 0.13833691920347907, 0.8516557564660104, 0.010007324330510414])
    c.append([0.3415651178759441, 0.2516758983749142, 0.40675898374914166, 0.01, 0.8099876401922637, 0.18001235980773633, 0.49, 0.020000000000000018, 0.49, 0.13833691920347907, 0.8516557564660104, 0.010007324330510414])
    c.append([0.3415651178759441, 0.2516758983749142, 0.40675898374914166, 0.01, 0.8099876401922637, 0.18001235980773633, 0.49, 0.020000000000000018, 0.49, 0.13833691920347907, 0.8516557564660104, 0.010007324330510414])
    # line 6 (same with line 3) (21-24)
    c.append([0.48999267566948956, 0.020007324330510445, 0.49, 0.01, 0.9312346074616618, 0.05876539253833829, 0.49, 0.020000000000000018, 0.49, 0.22290363927672235, 0.7670963607232777, 0.01])
    c.append([0.3175632867933166, 0.26967177843900203, 0.4127649347676814, 0.01, 0.7767425040054933, 0.21325749599450675, 0.49, 0.020000000000000018, 0.49, 0.08279652094300755, 0.9072034790569925, 0.01])
    c.append([0.49, 0.020007324330510445, 0.48999267566948956, 0.01, 0.9333220416571297, 0.056677958342870226, 0.49, 0.020000000000000018, 0.49, 0.20164110780498973, 0.7883588921950102, 0.01])
    c.append([0.49, 0.020007324330510445, 0.48999267566948956, 0.01, 0.9333220416571297, 0.056677958342870226, 0.49, 0.020000000000000018, 0.49, 0.20164110780498973, 0.7883588921950102, 0.01])
    # line 7 (same with line 2) (25-28)
    c.append([0.3547196154726482, 0.25119249256122683, 0.394087891966125, 0.018386358434424356, 0.7630826276035706, 0.21853101396200506, 0.48138658731975276, 0.040368963149462256, 0.47824444953078504, 0.12203295948729685, 0.8067136644541085, 0.07125337605859464])
    c.append([0.3021748683909361, 0.27835111009384306, 0.41947402151522084, 0.01, 0.7604678416113527, 0.2295321583886473, 0.49, 0.020000000000000018, 0.49, 0.04013962005035477, 0.9498530556191348, 0.010007324330510414])
    c.append([0.29957473105973903, 0.28084870679789437, 0.41957656214236666, 0.01, 0.7604458686198214, 0.22955413138017852, 0.49, 0.020000000000000018, 0.49, 0.03797161821927215, 0.9520283817807278, 0.01])
    c.append([0.2928290226596475, 0.28472327763790345, 0.42244769970244905, 0.010007324330510414, 0.7565786221103227, 0.23341405355916686, 0.49, 0.020000000000000018, 0.49, 0.023872281986724652, 0.9661277180132753, 0.01])
    # line 8 (same with line 1) (29-33)
    c.append([0.4192323186083772, 0.15182330052643628, 0.42894438086518655, 0.033789425497825584, 0.8161986724650949, 0.15001190203707943, 0.48299061570153357, 0.08418310826276032, 0.4328262760357061, 0.24443717097734036, 0.6552904554818036, 0.10027237354085602])
    c.append([0.4192323186083772, 0.15182330052643628, 0.42894438086518655, 0.033789425497825584, 0.8161986724650949, 0.15001190203707943, 0.48299061570153357, 0.08418310826276032, 0.4328262760357061, 0.24443717097734036, 0.6552904554818036, 0.10027237354085602])
    c.append([0.4735861753261616, 0.07128496223392072, 0.4551288624399176, 0.16833005264362555, 0.7642471961547265, 0.06742275120164798, 0.4478045319295033, 0.17346669718471047, 0.3787287708857862, 0.07839459830624856, 0.8223657587548637, 0.09923964293888761])
    c.append([0.3840975051499199, 0.4537907988097963, 0.1621116960402838, 0.03563515678644999, 0.8224097047379263, 0.14195513847562372, 0.47512428473334856, 0.08438086518654159, 0.44049485008010986, 0.1313861295490959, 0.7447498283360037, 0.12386404211490042])
    c.append([0.4245571068894484, 0.11386861982146934, 0.4615742732890822, 0.1070766765850309, 0.8007956054016938, 0.09212771801327534, 0.2818498512245365, 0.3823273060196842, 0.3358228427557794, 0.16096910048065918, 0.7558974593728542, 0.0831334401464866])

    # paramater setting
    # line 1 to 8
    line_start_index, line_end_index = 0, 0
    for line in range(8):
        square_index_inline = 0
        match line:
            case 0:
                line_start_index = 0
                line_end_index = 5
            case 1:
                line_start_index = 5
                line_end_index = 9
            case 2:
                line_start_index = 9
                line_end_index = 13
            case 3:
                line_start_index = 13
                line_end_index = 17
            case 4:
                line_start_index = 17
                line_end_index = 21
            case 5:
                line_start_index = 21
                line_end_index = 25
            case 6:
                line_start_index = 25
                line_end_index = 29
            case 7:
                line_start_index = 29
                line_end_index = 34
    
        for i in range(line_start_index, line_end_index):
            for d_index, di in enumerate(c[i]): 
                model.param("par" + str(i+2)).set("d" + str(d_index+1) + "_" + str(i+1), "d*" + str(di))
            # x move offset 
            model.param("par" + str(i+2)).set("x" + str(i+1), "-r2+(d+squa_offset)*" + str(square_index_inline))
            square_index_inline = square_index_inline + 1
            # same line, y not offset
            model.param("par" + str(i+2)).set("y" + str(i+1), "-rect_h/2+(d+squa_offset)*" + str(line))
    
    # construct geometry 
    for i in range(1, 35):
        set_cross_shape(model, "pol"+str(i), "x"+str(i), "y"+str(i), str(i))

    # 求差，获取需要挖空的部分
    cross_shape_i = 1
    colmuns = 0
    for line_num in range(8):
        match line_num:
            case 0:
                colmuns = 5
            case 7:
                colmuns = 5
            case _:
                colmuns = 4
        
        for col_num in range(colmuns):
            set_diff(model, "dif"+str(cross_shape_i), "arr1(" + str(col_num+1) + ","  + str(line_num+1) + ")", "pol"+str(cross_shape_i))
            cross_shape_i = cross_shape_i + 1

    model.save(model_path)


def set_cross_shape(model, pol_id, x_id, y_id, d_id):
    model.component("comp1").geom("geom1").create(pol_id, "Polygon");
    model.component("comp1").geom("geom1").feature(pol_id).set("source", "table");
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id, 0, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id, 1, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d12_"+d_id, 0, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d11_"+d_id+"+d12_"+d_id, 1, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d11_"+d_id+"+d12_"+d_id, 2, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d9_"+d_id, 2, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d", 3, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d9_"+d_id, 3, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d", 4, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d9_"+d_id+"+d8_"+d_id, 4, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d4_"+d_id+"+d5_"+d_id, 5, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d9_"+d_id+"+d8_"+d_id, 5, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d4_"+d_id+"+d5_"+d_id, 6, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d", 6, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d4_"+d_id, 7, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d", 7, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d1_"+d_id+"+d2_"+d_id, 8, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d4_"+d_id, 8, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id, 9, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d1_"+d_id+"+d2_"+d_id, 9, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id, 10, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d1_"+d_id, 10, 1);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", x_id+"+d12_"+d_id, 11, 0);
    model.component("comp1").geom("geom1").feature(pol_id).setIndex("table", y_id+"+d1_"+d_id, 11, 1);


def set_diff(model, diff_id, square_id, cross_shape_id):
    model.component("comp1").geom("geom1").create(diff_id, "Difference");
    # arr1(1,1) now allowed to select
    model.component("comp1").geom("geom1").feature(diff_id).selection("input").set(square_id);
    model.component("comp1").geom("geom1").feature(diff_id).selection("input2").set(cross_shape_id);



mph.option('session', 'stand-alone')
client = mph.start(cores=1)
client.caching(False)
# model_name = 'cross-shape-horizontal'
model_name = 'cross-shape-parameterized'
model = client.load('./basic_model/'+ model_name  + '.mph')
set_param_and_geometry(model, './basic_model/'+model_name+"-2-optm.mph")

sys.stdout.flush()

# to free up memory
model.clear()
model.reset()

